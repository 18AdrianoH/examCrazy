<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Exam Crazy</title>
<style>
body {
	background-color: lightblue;
}
</style>
<script src="https://www.gstatic.com/firebasejs/3.6.8/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyB0YLiSfVf8aDluRvk268eCL_mpZFXYug0",
    authDomain: "exam-crazy.firebaseapp.com",
    databaseURL: "https://exam-crazy.firebaseio.com",
    storageBucket: "exam-crazy.appspot.com",
    messagingSenderId: "788284782428"
  };
  firebase.initializeApp(config);
</script>
<!--<script type="text/javascript" src="code.js"></script>!-->
<script>
	
var id = 0;
	
var messages = [""];

var messagesRef;

var currentColor = [0, 0, 0];
var targetColor = [0, 0, 0];
	
function update(){
	var el = document.getElementById("messages");
	el.innerHTML = msgsToString();	
	el.scrollTop = el.scrollHeight;
}
	
document.onload = function(){
	//update();
	var i = 0;
	setInterval(function(){
		console.log(i);
		if(i % 2000 == 0){
			targetColor = [Math.random() * 255, Math.random() * 255, Math.random() * 255];
		}
		
		for(var j = 0; j < currentColor.length; j++){
			currentColor[j] += (targetColor[j] - currentColor[j])/10.0;
		}
		
		document.body.style.background = "rgb(" + Math.trunc(currentColor[0]) + "," + Math.trunc(currentColor[1]) + "," + Math.trunc(currentColor[2]) + ")";
		
		i++;
	}, 100);
};

function read(){
	/*firebase.database().ref('messages').once('value').then(function(snapshot) {
		messages = snapshot.val().messages;
		if(messages == null){
			messages = [""];	
		}
	});	*/
}
	
function msgsToString(){
	var str = "";
	for(var i = 0; i < messages.length; i++){
		str += messages[i] + "<br>";
	}
	return str;
}

function clearTextBox(){
	document.getElementById("textbox").value = "";
}

function keyUp(event){
	var x = event.which || event.keyCode;
	if(x == 13){
		if(id == 0){
			var entered = document.getElementById("textbox").value;
			if(entered.length > 0){
				messagesRef = firebase.database().ref('messages/'+entered);
				
				firebase.database().ref('messages/'+entered).once('value').then(function(snapshot) {
					if(snapshot.val() == null){
						if(entered == "1"){
							firebase.database().ref('messages/1').set({
								messages: [""]
							});
						}
						else {
							alert("Incorrect chat PIN.");
						}
					}
					else {
						id = entered;
						document.getElementById("header").innerHTML = "You have joined "+entered;
						messages = snapshot.val().messages;
						if(messages == null){
							messages = [""];
						}
						
						messagesRef.on('value', function(snapshot) {
							messages = snapshot.val().messages;
							if(messages == null){
								messages = [""];
							}
							update();
						});
						update();
					}
				});
		        }
			
			clearTextBox();
		}
		else {
			var text = document.getElementById("textbox").value;
			var body = document.getElementById("body").innerHTML;
			read();
			messages.push(text);
			firebase.database().ref('messages/'+id).set({
				messages: messages
			});
			update();
			//document.getElementById("body").innerHTML = text + "<br>" + body;
			clearTextBox();
			$("#textbox").focus();
		}
	}
}

</script>
<script src="https://code.jquery.com/jquery-3.1.0.js"></script>
</head>
<body id = "body" >
<div align="center">
	<h1 id = "header">Please input the chat PIN.</h1>
  <input id = "textbox" type = "text" onkeyup = "keyUp(event)">
  <h5> or <a href="createagame.html">launch an invocation on your steed</a> </h5>
  </div>
	<div id = "messages" style = "height: 500px; font-family:Arial Black; overflow-y: scroll;"></div>
</body>
</html>

